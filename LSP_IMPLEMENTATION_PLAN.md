# YINI Language Server Protocol (LSP) å®æ–½è®¡åˆ’

**ç›®æ ‡ç‰ˆæœ¬**: v1.3.0  
**ä¼˜å…ˆçº§**: é«˜  
**çŠ¶æ€**: è§„åˆ’é˜¶æ®µ

---

## ğŸ¯ ç›®æ ‡

ä¸ºYINIè¯­è¨€æä¾›å®Œæ•´çš„LSPæ”¯æŒï¼Œå®ç°ç°ä»£åŒ–çš„IDEå¼€å‘ä½“éªŒã€‚

---

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½æ¸…å•

### é˜¶æ®µ1ï¼šåŸºç¡€LSPæœåŠ¡å™¨ (1-2å‘¨)

#### 1.1 LSPæœåŠ¡å™¨æ¡†æ¶ âœ…
- [ ] é€‰æ‹©LSPåº“ï¼ˆæ¨èï¼šNode.js + vscode-languageserverï¼‰
- [ ] æ­å»ºåŸºç¡€æœåŠ¡å™¨ç»“æ„
- [ ] å®ç°åˆå§‹åŒ–åè®®
- [ ] æ–‡æ¡£åŒæ­¥æœºåˆ¶

#### 1.2 åŸºç¡€è¯Šæ–­ (Diagnostics)
- [ ] é›†æˆYINI Parser
- [ ] è¯­æ³•é”™è¯¯æ£€æµ‹
- [ ] å®æ—¶é”™è¯¯æŠ¥å‘Š
- [ ] é”™è¯¯ä½ç½®æ˜ å°„

### é˜¶æ®µ2ï¼šæ™ºèƒ½ç¼–è¾‘åŠŸèƒ½ (2-3å‘¨)

#### 2.1 è‡ªåŠ¨è¡¥å…¨ (Completion)
- [ ] å…³é”®å­—è¡¥å…¨
  - `[#define]`, `[#include]`, `[#schema]`
  - Sectionåç§°
  - æ•°æ®ç±»å‹ï¼ˆColor, Coord, Listç­‰ï¼‰
- [ ] å®å¼•ç”¨è¡¥å…¨
  - `@` è§¦å‘å®åè¡¥å…¨
  - æ˜¾ç¤ºå®çš„å®é™…å€¼
- [ ] æ¨ªæˆªé¢å¼•ç”¨è¡¥å…¨
  - `@{` è§¦å‘Sectionåè¡¥å…¨
  - `.` è§¦å‘é”®åè¡¥å…¨

#### 2.2 æ‚¬åœæç¤º (Hover)
- [ ] æ˜¾ç¤ºå€¼ç±»å‹
- [ ] æ˜¾ç¤ºå®å®šä¹‰å†…å®¹
- [ ] æ˜¾ç¤ºå¼•ç”¨çš„å®é™…å€¼
- [ ] SchemaéªŒè¯ä¿¡æ¯

#### 2.3 å®šä¹‰è·³è½¬ (Go to Definition)
- [ ] å®å¼•ç”¨è·³è½¬åˆ°å®šä¹‰
- [ ] æ¨ªæˆªé¢å¼•ç”¨è·³è½¬åˆ°section
- [ ] Includeæ–‡ä»¶è·³è½¬

### é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ (3-4å‘¨)

#### 3.1 ä»£ç æ ¼å¼åŒ– (Formatting)
- [ ] è‡ªåŠ¨ç¼©è¿›
- [ ] å¯¹é½é”®å€¼å¯¹
- [ ] è§„èŒƒåŒ–ç©ºæ ¼

#### 3.2 ç¬¦å·æŸ¥æ‰¾ (Document Symbols)
- [ ] Sectionå¤§çº²
- [ ] é”®å€¼å¯¹åˆ—è¡¨
- [ ] å®å®šä¹‰åˆ—è¡¨

#### 3.3 å¼•ç”¨æŸ¥æ‰¾ (Find References)
- [ ] æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨æŸä¸ªå®çš„ä½ç½®
- [ ] æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨æŸä¸ªsection.keyçš„ä½ç½®

#### 3.4 é‡å‘½å (Rename)
- [ ] é‡å‘½åå®ï¼ˆæ›´æ–°æ‰€æœ‰å¼•ç”¨ï¼‰
- [ ] é‡å‘½åsection
- [ ] é‡å‘½åkey

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### LSPæœåŠ¡å™¨æŠ€æœ¯æ ˆ

```
YINI LSP Server
â”œâ”€â”€ è¯­è¨€: TypeScript/Node.js
â”œâ”€â”€ LSPåº“: vscode-languageserver
â”œâ”€â”€ Parser: è°ƒç”¨C++ YINI Parser (é€šè¿‡FFIæˆ–å­è¿›ç¨‹)
â””â”€â”€ åè®®ç‰ˆæœ¬: LSP 3.17
```

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   VSCode    â”‚
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ JSON-RPC
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   YINI LSP Server           â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Document Manager  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  YINI Parser       â”‚â”€â”€â”€â”€â”¼â”€â†’ C++ Parser
â”‚  â”‚  (via child_process)â”‚    â”‚   (yini_cli)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Completion        â”‚     â”‚
â”‚  â”‚  Provider          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Diagnostics       â”‚     â”‚
â”‚  â”‚  Provider          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Hover Provider    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Definition        â”‚     â”‚
â”‚  â”‚  Provider          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
yini-lsp/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.ts              # LSPæœåŠ¡å™¨å…¥å£
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ yiniParser.ts      # Parseræ¥å£
â”‚   â”‚   â””â”€â”€ cliAdapter.ts      # è°ƒç”¨yini_cli
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ completion.ts      # è‡ªåŠ¨è¡¥å…¨
â”‚   â”‚   â”œâ”€â”€ diagnostics.ts     # è¯Šæ–­
â”‚   â”‚   â”œâ”€â”€ hover.ts           # æ‚¬åœ
â”‚   â”‚   â”œâ”€â”€ definition.ts      # å®šä¹‰è·³è½¬
â”‚   â”‚   â””â”€â”€ formatting.ts      # æ ¼å¼åŒ–
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ symbolTable.ts     # ç¬¦å·è¡¨
â”‚   â”‚   â””â”€â”€ referenceResolver.ts  # å¼•ç”¨è§£æ
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ position.ts        # ä½ç½®å·¥å…·
â”œâ”€â”€ client/                    # VSCodeå®¢æˆ·ç«¯æ‰©å±•
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ extension.ts       # VSCodeæ‰©å±•å…¥å£
â””â”€â”€ test/
    â””â”€â”€ *.test.ts
```

---

## ğŸ› ï¸ å®æ–½æ­¥éª¤

### Step 1: ç¯å¢ƒå‡†å¤‡
```bash
cd /workspace
mkdir yini-lsp
cd yini-lsp
npm init -y
npm install vscode-languageserver vscode-languageserver-textdocument
npm install --save-dev @types/node typescript
```

### Step 2: åŸºç¡€æœåŠ¡å™¨
åˆ›å»ºæœ€å°åŒ–LSPæœåŠ¡å™¨ï¼š
- åˆå§‹åŒ–è¿æ¥
- æ–‡æ¡£åŒæ­¥
- åŸºç¡€è¯Šæ–­ï¼ˆè°ƒç”¨yini_cli checkï¼‰

### Step 3: è‡ªåŠ¨è¡¥å…¨
å®ç°æœ€æœ‰ä»·å€¼çš„åŠŸèƒ½ï¼š
- å…³é”®å­—è¡¥å…¨
- å®å¼•ç”¨è¡¥å…¨ `@`
- Sectionå¼•ç”¨è¡¥å…¨ `@{`

### Step 4: å…¶ä»–åŠŸèƒ½
é€æ­¥æ·»åŠ ï¼š
- Hover
- Go to Definition
- Formatting

---

## ğŸ¨ VSCodeå®¢æˆ·ç«¯å¢å¼º

### å½“å‰çŠ¶æ€ï¼ˆv1.0ï¼‰
```json
{
  "contributes": {
    "languages": [{
      "id": "yini",
      "extensions": [".yini", ".YINI"]
    }],
    "grammars": [{
      "language": "yini",
      "scopeName": "source.yini",
      "path": "./syntaxes/yini.tmLanguage.json"
    }]
  }
}
```

### å¢å¼ºåï¼ˆv2.0ï¼‰
```json
{
  "contributes": {
    "languages": [...],
    "grammars": [...],
    "configuration": {
      "title": "YINI",
      "properties": {
        "yini.trace.server": {
          "type": "string",
          "enum": ["off", "messages", "verbose"],
          "default": "off",
          "description": "LSP server trace level"
        },
        "yini.format.enable": {
          "type": "boolean",
          "default": true,
          "description": "Enable auto-formatting"
        }
      }
    }
  },
  "activationEvents": [
    "onLanguage:yini"
  ]
}
```

---

## ğŸ’¡ å…³é”®åŠŸèƒ½æ¼”ç¤º

### 1. è‡ªåŠ¨è¡¥å…¨ç¤ºä¾‹

**è¾“å…¥åœºæ™¯1**ï¼š
```yini
[#d|  <- å…‰æ ‡ä½ç½®
```
**è¡¥å…¨å»ºè®®**ï¼š
- `[#define]`
- `[#include]`  
- `[#schema]`

**è¾“å…¥åœºæ™¯2**ï¼š
```yini
[#define]
WIDTH = 1920

[Graphics]
w = @|  <- å…‰æ ‡ä½ç½®
```
**è¡¥å…¨å»ºè®®**ï¼š
- `@WIDTH` (â†’ 1920)

**è¾“å…¥åœºæ™¯3**ï¼š
```yini
[Config]
width = 1920

[UI]
w = @{|  <- å…‰æ ‡ä½ç½®
```
**è¡¥å…¨å»ºè®®**ï¼š
- `@{Config`
- (è¾“å…¥`.`å) `@{Config.width`

### 2. æ‚¬åœæç¤ºç¤ºä¾‹

**æ‚¬åœåœ¨**ï¼š
```yini
width = @WIDTH
        ^^^^^
```
**æ˜¾ç¤º**ï¼š
```
@WIDTH
Type: INTEGER
Value: 1920
Defined in: [#define]:2
```

### 3. å®šä¹‰è·³è½¬ç¤ºä¾‹

**åœ¨æ­¤æŒ‰F12**ï¼š
```yini
width = @WIDTH
        ^^^^^
```
**è·³è½¬åˆ°**ï¼š
```yini
[#define]
WIDTH = 1920  â† è¿™é‡Œ
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```typescript
describe('CompletionProvider', () => {
  it('should complete macro references', () => {
    const doc = parseDocument('[#define]\nW=1\n[A]\nv=@');
    const completions = getCompletions(doc, position(3, 3));
    expect(completions).toContainEqual({
      label: '@W',
      kind: CompletionItemKind.Variable
    });
  });
});
```

### é›†æˆæµ‹è¯•
- ä½¿ç”¨VSCode Extension Test Runner
- æ¨¡æ‹ŸçœŸå®ç¼–è¾‘åœºæ™¯
- éªŒè¯LSPåè®®æ¶ˆæ¯

---

## ğŸ“Š ä¼˜å…ˆçº§æ’åº

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å½±å“ | å·¥ä½œé‡ |
|------|--------|------|--------|
| è¯­æ³•é”™è¯¯è¯Šæ–­ | ğŸ”´ æœ€é«˜ | å³æ—¶åé¦ˆ | ä¸­ |
| è‡ªåŠ¨è¡¥å…¨ | ğŸ”´ æœ€é«˜ | æå‡æ•ˆç‡ | é«˜ |
| å®šä¹‰è·³è½¬ | ğŸŸ¡ é«˜ | ä»£ç å¯¼èˆª | ä¸­ |
| æ‚¬åœæç¤º | ğŸŸ¡ é«˜ | ä¿¡æ¯æŸ¥çœ‹ | ä½ |
| æ ¼å¼åŒ– | ğŸŸ¢ ä¸­ | ä»£ç ç¾åŒ– | ä¸­ |
| å¼•ç”¨æŸ¥æ‰¾ | ğŸŸ¢ ä¸­ | é‡æ„è¾…åŠ© | é«˜ |
| é‡å‘½å | ğŸŸ¢ ä¸­ | é‡æ„è¾…åŠ© | é«˜ |

---

## âš¡ æ€§èƒ½è€ƒè™‘

### Parserç¼“å­˜
```typescript
class DocumentCache {
  private cache = new Map<string, ParsedDocument>();
  
  get(uri: string, version: number) {
    const cached = this.cache.get(uri);
    if (cached && cached.version === version) {
      return cached.ast;
    }
    return null;
  }
}
```

### å¢é‡è§£æ
- åªåœ¨æ–‡æ¡£å˜æ›´æ—¶é‡æ–°è§£æ
- ç¼“å­˜ç¬¦å·è¡¨
- å¼‚æ­¥è¯Šæ–­

---

## ğŸš€ å‘å¸ƒè®¡åˆ’

### v1.3.0-alpha (2å‘¨å)
- âœ… åŸºç¡€LSPæœåŠ¡å™¨
- âœ… è¯­æ³•é”™è¯¯è¯Šæ–­
- âœ… å…³é”®å­—è¡¥å…¨

### v1.3.0-beta (4å‘¨å)
- âœ… å®å¼•ç”¨è¡¥å…¨
- âœ… æ¨ªæˆªé¢å¼•ç”¨è¡¥å…¨
- âœ… æ‚¬åœæç¤º
- âœ… å®šä¹‰è·³è½¬

### v1.3.0-stable (6å‘¨å)
- âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… æ–‡æ¡£å®Œå–„

---

## ğŸ“š å‚è€ƒèµ„æº

### LSPç›¸å…³
- [LSPè§„èŒƒ](https://microsoft.github.io/language-server-protocol/)
- [vscode-languageserver](https://www.npmjs.com/package/vscode-languageserver)
- [LSPç¤ºä¾‹](https://github.com/microsoft/vscode-extension-samples/tree/main/lsp-sample)

### VSCodeæ‰©å±•
- [VSCode Extension API](https://code.visualstudio.com/api)
- [Extension Guidelines](https://code.visualstudio.com/api/references/extension-guidelines)

---

## âœ… æˆåŠŸæ ‡å‡†

### ç”¨æˆ·ä½“éªŒ
- [x] è¯­æ³•é”™è¯¯å®æ—¶æ˜¾ç¤ºï¼ˆçº¢è‰²æ³¢æµªçº¿ï¼‰
- [x] è¾“å…¥`@`è‡ªåŠ¨å¼¹å‡ºå®åˆ—è¡¨
- [x] è¾“å…¥`@{`è‡ªåŠ¨å¼¹å‡ºSectionåˆ—è¡¨
- [x] æ‚¬åœæ˜¾ç¤ºå€¼ä¿¡æ¯
- [x] F12è·³è½¬åˆ°å®šä¹‰
- [x] æ ¼å¼åŒ–å¿«æ·é”®ç”Ÿæ•ˆ

### æŠ€æœ¯æŒ‡æ ‡
- [ ] è¯Šæ–­å»¶è¿Ÿ < 100ms
- [ ] è¡¥å…¨å»¶è¿Ÿ < 50ms
- [ ] å†…å­˜å ç”¨ < 50MB
- [ ] CPUä½¿ç”¨ç‡ < 5%

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹**: åˆ›å»ºyini-lspç›®å½•ç»“æ„
2. **ç¬¬1å‘¨**: å®ç°åŸºç¡€LSPæœåŠ¡å™¨å’Œè¯Šæ–­
3. **ç¬¬2å‘¨**: å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
4. **ç¬¬3å‘¨**: å®ç°æ‚¬åœå’Œå®šä¹‰è·³è½¬
5. **ç¬¬4å‘¨**: æµ‹è¯•å’Œä¼˜åŒ–

---

**çŠ¶æ€**: âœ… è§„åˆ’å®Œæˆï¼Œå‡†å¤‡å¼€å§‹å®æ–½  
**ä¸‹ä¸€æ­¥**: åˆ›å»ºyini-lspé¡¹ç›®éª¨æ¶  
**é¢„è®¡å®Œæˆ**: 6å‘¨åå‘å¸ƒv1.3.0

---

**è§„åˆ’æ—¥æœŸ**: 2025-10-06  
**è§„åˆ’äºº**: AI Assistant  
**é¡¹ç›®**: YINI Language Server Protocol

name: Release YINI Packages

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-native:
    name: Build Native Library (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: libYini.so
            build_path: build/src/libYini.so
            runtime_id: linux-x64
          - os: windows-latest
            artifact_name: Yini.dll
            build_path: build/src/Release/Yini.dll
            runtime_id: win-x64
          - os: macos-latest
            artifact_name: libYini.dylib
            build_path: build/src/libYini.dylib
            runtime_id: osx-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build Native Library
        run: cmake --build build --config Release --target Yini

      - name: Upload Native Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.build_path }}

  publish:
    name: Package and Publish
    needs: build-native
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Log version being released
        run: echo "Triggered release for tag ${{ github.ref_name }}"

      - name: Get the version from the tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Download all native artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/native

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create NuGet runtimes directory
        run: |
          mkdir -p csharp/Yini/runtimes/win-x64/native
          mkdir -p csharp/Yini/runtimes/linux-x64/native
          mkdir -p csharp/Yini/runtimes/osx-x64/native

      - name: Move native binaries to correct runtime folders
        run: |
          mv artifacts/native/Yini.dll/Yini.dll csharp/Yini/runtimes/win-x64/native/
          mv artifacts/native/libYini.so/libYini.so csharp/Yini/runtimes/linux-x64/native/
          mv artifacts/native/libYini.dylib/libYini.dylib csharp/Yini/runtimes/osx-x64/native/

      - name: Update Yini.csproj version
        run: |
          sed -i 's|<Version>.*</Version>|<Version>${{ env.VERSION }}</Version>|' csharp/Yini/Yini.csproj
          echo "Updated Yini.csproj to version ${{ env.VERSION }}"

      - name: Update package.json version
        run: |
          npm version --no-git-tag-version --allow-same-version ${{ env.VERSION }}
          echo "Updated package.json to version ${{ env.VERSION }}"
        working-directory: ./ide/VSIX

      - name: Pack NuGet package
        run: dotnet pack --configuration Release csharp/Yini/Yini.csproj -o ./artifacts/nuget

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package VSIX
        run: |
          cd ide/VSIX
          npm install
          vsce package -o ../../artifacts/vsix/yini-vscode-${{ env.VERSION }}.vsix
          cd ../..

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            ./artifacts/nuget/*.nupkg
            ./artifacts/vsix/*.vsix